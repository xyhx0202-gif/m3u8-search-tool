<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8è§†é¢‘æœç´¢å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
      // Cloudflare Pageséƒ¨ç½²é…ç½®
      const API_BASE_URL = ''; // åœ¨Cloudflare Pagesä¸Šï¼ŒAPIè¯·æ±‚å°†é€šè¿‡_redirectsæ–‡ä»¶å¤„ç†
      const USE_CLOUDFLARE_WORKER = true; // æ˜¯å¦ä½¿ç”¨Cloudflare Workerå¤„ç†APIè¯·æ±‚
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            border-color: #667eea;
        }
        .search-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s;
        }
        .search-btn:hover {
            transform: translateY(-2px);
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .results {
            display: none;
        }
        .result-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .result-item:hover {
            background: #e9ecef;
        }
        .player {
            display: none;
            margin-top: 20px;
        }
        .video-player {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .m3u8-url {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin-bottom: 15px;
        }
        .episodes {
            display: none;
            margin-top: 20px;
        }
        .episode-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        .episode-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .episode-item:hover {
            background: #e9ecef;
        }
        .episode-item.active {
            background: #667eea;
            color: white;
        }
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .video-info {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e3e8f0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        .video-info:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .video-cover {
            flex-shrink: 0;
            width: 220px;
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .video-cover:hover {
            border-color: #667eea;
            transform: scale(1.02);
        }
        
        .video-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .video-cover:hover img {
            transform: scale(1.05);
        }
        
        .video-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .video-details h3 {
            font-size: 24px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            line-height: 1.3;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .video-description {
            line-height: 1.8;
            color: #4a5568;
            font-size: 15px;
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            white-space: pre-line;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .video-description strong {
            color: #2d3748;
            font-weight: 600;
            display: inline-block;
            min-width: 60px;
        }
        
        .video-description .info-line {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .video-description .info-line:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .video-description .info-title {
            color: #2d3748;
            font-weight: 600;
            display: inline-block;
            min-width: 50px;
            margin-right: 10px;
        }
        
        .video-description .info-content {
            color: #4a5568;
        }
        
        .video-description .synopsis {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
            line-height: 1.7;
            color: #4a5568;
        }
        
        .no-cover {
            font-size: 16px;
            text-align: center;
            padding: 30px 20px;
            color: #718096;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }
        
        .no-cover small {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 8px;
            opacity: 0.8;
        }
        
        .no-cover.loading {
            color: #667eea;
            border-color: #667eea;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .no-cover.error {
            color: #e53e3e;
            border-color: #fc8181;
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        }
        
        .no-cover.success {
            color: #38a169;
            border-color: #68d391;
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ M3U8è§†é¢‘æœç´¢å·¥å…·</h1>
            <p>è¾“å…¥è§†é¢‘åç§°ï¼Œä¸€é”®è·å–M3U8æ’­æ”¾åœ°å€</p>
        </div>
        
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="è¯·è¾“å…¥è§†é¢‘åç§°...">
            <button class="search-btn" onclick="searchVideo()">æœç´¢</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨æœç´¢ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="results" id="results">
            <h3>æœç´¢ç»“æœ</h3>
            <div id="resultsList"></div>
        </div>
        
        <div class="player" id="player">
            <button class="back-btn" onclick="backToSearch()">â† è¿”å›æœç´¢</button>
            
            <div class="video-info" id="videoInfo">
                <div class="video-cover" id="videoCover">
                    <div class="no-cover">æš‚æ— å°é¢</div>
                </div>
                <div class="video-details">
                    <h3 id="videoTitle"></h3>
                    <div class="video-description" id="videoDescription">
                        æš‚æ— ç®€ä»‹
                    </div>
                </div>
            </div>
            
            <video class="video-player" id="videoPlayer" controls>
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
            </video>
            
            <div class="episodes" id="episodes">
                <h4>åˆ†é›†åˆ—è¡¨</h4>
                <div class="episode-list" id="episodesList"></div>
            </div>
        </div>
    </div>

    <script>
        // ç§»é™¤åŠ å¯†åŠŸèƒ½ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹URL
        
        // ç”ŸæˆAPIè°ƒç”¨token - ä¿®æ”¹ä¸ºä¸åç«¯åŒ¹é…çš„æ ¼å¼
        function generateApiToken() {
            // ä½¿ç”¨ç§’çº§æ—¶é—´æˆ³ï¼ˆä¸åç«¯ä¸€è‡´ï¼‰
            const timestamp = Math.floor(Date.now() / 1000);
            // ä½¿ç”¨å›ºå®šå¯†é’¥éƒ¨åˆ†ï¼ˆä¸åç«¯API_SECRET_KEY[2:8]åŒ¹é…ï¼‰
            const secretPart = '3U8V1d';
            return timestamp + '_' + secretPart;
        }

        let currentVideo = null;
        let currentEpisodes = [];
        
        // é€šç”¨APIè¯·æ±‚å‡½æ•°ï¼Œæ”¯æŒTokenè¿‡æœŸè‡ªåŠ¨é‡è¯•å’Œé”™è¯¯å¤„ç†
        function apiRequest(url, options = {}, retries = 2) {
            // ç¡®ä¿headerså¯¹è±¡å­˜åœ¨
            if (!options.headers) {
                options.headers = {};
            }
            
                // ä½¿ç”¨å®Œæ•´çš„API URL
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·é…ç½®çš„æœåŠ¡å™¨åœ°å€ï¼Œæˆ–è€…ä½¿ç”¨é»˜è®¤å€¼
            const defaultServerUrl = window.API_BASE_URL || 'http://localhost:8888';
            const fullUrl = url.startsWith('http') ? url : defaultServerUrl + url;
            console.log('APIè¯·æ±‚URL:', fullUrl);
            
            // è®¾ç½®API headers
            options.headers['X-API-Key'] = 'm3u8_viewer_key';
            options.headers['X-API-Token'] = generateApiToken();
            
            // è®¾ç½®é»˜è®¤é€‰é¡¹
            options.mode = 'cors';
            options.cache = 'no-cache';
            options.credentials = 'same-origin';
            
            // æ·»åŠ è¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // å¢åŠ è¶…æ—¶æ—¶é—´åˆ°30ç§’
            options.signal = controller.signal;
            
            return fetch(fullUrl, options)
                .then(response => {
                    clearTimeout(timeoutId);
                    
                    // æ£€æŸ¥å“åº”çŠ¶æ€
                    if (!response.ok) {
                        // å°è¯•è·å–é”™è¯¯è¯¦æƒ…
                        return response.text().then(text => {
                            try {
                                const data = JSON.parse(text);
                                throw new Error(data.error || `è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                            } catch {
                                throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                            }
                        });
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºTokenè¿‡æœŸï¼ˆ401çŠ¶æ€ç ä¸”æœ‰errorå­—æ®µï¼‰
                    return response.text().then(text => {
                        try {
                            const data = JSON.parse(text);
                            if (response.status === 401 && data.error === 'Token expired') {
                                // é‡æ–°ç”ŸæˆTokenå¹¶è¯·æ±‚
                                options.headers['X-API-Token'] = generateApiToken();
                                return apiRequest(url, options);
                            }
                            return data;
                        } catch (e) {
                            throw new Error('æ— æ•ˆçš„å“åº”æ ¼å¼');
                        }
                    });
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    
                    // å¤„ç†ç‰¹å®šé”™è¯¯ç±»å‹
                    if (error.name === 'AbortError') {
                        throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    
                    // ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡è¯•
                    if ((error.message.includes('Failed to fetch') || error.message.includes('ERR_ABORTED')) && retries > 0) {
                        console.log(`ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡è¯•(${2 - retries + 1}/3)...`);
                        return new Promise(resolve => {
                            setTimeout(() => {
                                resolve(apiRequest(url, options, retries - 1));
                            }, 1000);
                        });
                    }
                    
                    if (error.message.includes('Failed to fetch') || error.message.includes('ERR_ABORTED')) {
                        throw new Error('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ');
                    }
                    throw error;
                });
        }

        // é˜²æŠ–å‡½æ•°
        let searchTimeout;
        function debouncedSearch(videoName) {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            searchTimeout = setTimeout(() => {
                showLoading(true);
                hideError();
                
                apiRequest('/v1/query?q=' + encodeURIComponent(videoName))
            .then(data => {
                showLoading(false);
                if (data.error) {
                    showError(data.error);
                    return;
                }
                displayResults(data.results);
            })
            .catch(err => {
                showLoading(false);
                // ç‰¹æ®Šå¤„ç†é€Ÿç‡é™åˆ¶é”™è¯¯
                if (err.message.includes('Rate limit exceeded')) {
                    showError('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                } else {
                    showError('æœç´¢å¤±è´¥: ' + err.message);
                }
            });
            }, 500);
        }
        
        function searchVideo() {
            const videoName = document.getElementById('searchInput').value.trim();
            if (!videoName) {
                showError('è¯·è¾“å…¥è§†é¢‘åç§°');
                return;
            }
            
            // ä½¿ç”¨é˜²æŠ–ç‰ˆæœ¬çš„æœç´¢
            debouncedSearch(videoName);
        }
        
        function displayResults(results) {
            const list = document.getElementById('resultsList');
            list.innerHTML = '';
            
            results.forEach(r => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <strong>${r.title}</strong><br>
                    <small>ID: ${r.video_id}</small>
                `;
                div.onclick = function() {
                    selectVideo(r.video_id, r.title, r.play_url);
                };
                list.appendChild(div);
            });
            
            document.getElementById('results').style.display = 'block';
        }
        
        function selectVideo(videoId, title, playUrl) {
            currentVideo = {videoId, title, playUrl};
            showLoading(true);
            
            apiRequest('/v1/stream?id=' + videoId + '&play_url=' + encodeURIComponent(playUrl))
            .then(data => {
                showLoading(false);
                if (data.error) {
                    showError(data.error);
                    return;
                }
                showPlayer(data.m3u8_url, title, data.cover, data.description);
                if (data.episodes && data.episodes.length > 0) {
                    currentEpisodes = data.episodes;
                    showEpisodes(data.episodes, playUrl);
                }
            })
            .catch(err => {
                showLoading(false);
                showError('è·å–å¤±è´¥: ' + err.message);
            });
        }
        
        function showPlayer(m3u8Url, title, coverUrl, description) {
            document.getElementById('results').style.display = 'none';
            document.getElementById('player').style.display = 'block';
            
            // æ˜¾ç¤ºè§†é¢‘æ ‡é¢˜
            document.getElementById('videoTitle').textContent = title;
            
            // æ˜¾ç¤ºè§†é¢‘å°é¢ï¼ˆä¼˜åŒ–åŠ è½½å’Œé”™è¯¯å¤„ç†ï¼‰
            const coverElement = document.getElementById('videoCover');
            if (coverUrl && coverUrl.trim() !== '') {
                // åˆ›å»ºå›¾ç‰‡å¯¹è±¡è¿›è¡Œé¢„åŠ è½½å’Œé”™è¯¯å¤„ç†
                const img = new Image();
                img.src = coverUrl;
                img.alt = title;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                img.onload = function() {
                    // å›¾ç‰‡åŠ è½½æˆåŠŸ
                    coverElement.innerHTML = '';
                    coverElement.appendChild(img);
                };
                
                img.onerror = function() {
                    // å›¾ç‰‡åŠ è½½å¤±è´¥
                    coverElement.innerHTML = '<div class="no-cover error">å°é¢åŠ è½½å¤±è´¥<br><small>å°è¯•é‡æ–°åŠ è½½</small></div>';
                    // æ·»åŠ é‡è¯•åŠŸèƒ½
                    setTimeout(() => {
                        const retryImg = new Image();
                        retryImg.src = coverUrl + '?t=' + new Date().getTime(); // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                        retryImg.alt = title;
                        retryImg.style.width = '100%';
                        retryImg.style.height = '100%';
                        retryImg.style.objectFit = 'cover';
                        
                        retryImg.onload = function() {
                            coverElement.innerHTML = '';
                            coverElement.appendChild(retryImg);
                        };
                        
                        retryImg.onerror = function() {
                            coverElement.innerHTML = '<div class="no-cover error">å°é¢åŠ è½½å¤±è´¥<br><small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</small></div>';
                        };
                        
                        coverElement.innerHTML = '<div class="no-cover loading">æ­£åœ¨é‡æ–°åŠ è½½å°é¢...</div>';
                    }, 2000);
                };
                
                // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
                coverElement.innerHTML = '<div class="no-cover loading">å°é¢åŠ è½½ä¸­...</div>';
            } else {
                coverElement.innerHTML = '<div class="no-cover">æš‚æ— å°é¢</div>';
            }
            
            // æ˜¾ç¤ºè§†é¢‘ç®€ä»‹ï¼ˆæ ¼å¼åŒ–æ˜¾ç¤ºï¼‰
            const descElement = document.getElementById('videoDescription');
            if (description && description.trim() !== '') {
                descElement.innerHTML = formatVideoDescription(description);
            } else {
                descElement.textContent = 'æš‚æ— ç®€ä»‹';
            }
            
            const player = document.getElementById('videoPlayer');
            
            // é”€æ¯ä¹‹å‰çš„HLSå®ä¾‹
            if (window.hlsInstance) {
                window.hlsInstance.destroy();
            }
            
            // ä½¿ç”¨HLS.jsæ’­æ”¾M3U8
            if (Hls.isSupported()) {
                const hls = new Hls();
                window.hlsInstance = hls;
                // ç›´æ¥ä½¿ç”¨åŸå§‹M3U8åœ°å€
                hls.loadSource(m3u8Url);
                hls.attachMedia(player);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    player.play();
                });
            } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                // SafariåŸç”Ÿæ”¯æŒ
                player.src = m3u8Url;
                player.addEventListener('loadedmetadata', function() {
                    player.play();
                });
            } else {
                showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒM3U8è§†é¢‘æ’­æ”¾');
            }
        }
        
        function showEpisodes(episodes, currentUrl) {
            const list = document.getElementById('episodesList');
            list.innerHTML = '';
            
            episodes.forEach((ep, i) => {
                const div = document.createElement('div');
                div.className = 'episode-item';
                if (ep.url === currentUrl) div.classList.add('active');
                div.innerHTML = `
                    ${ep.title}
                `;
                div.onclick = function() {
                    playEpisode(ep.url, i);
                };
                list.appendChild(div);
            });
            
            document.getElementById('episodes').style.display = 'block';
        }
        
        function playEpisode(url, index) {
            showLoading(true);
            
            apiRequest('/v1/episodes?id=' + currentVideo.videoId + '&episode=' + encodeURIComponent(url))
            .then(data => {
                showLoading(false);
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                const player = document.getElementById('videoPlayer');
                
                // é”€æ¯ä¹‹å‰çš„HLSå®ä¾‹
                if (window.hlsInstance) {
                    window.hlsInstance.destroy();
                }
                
                // ä½¿ç”¨HLS.jsæ’­æ”¾M3U8
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    window.hlsInstance = hls;
                    // ç›´æ¥ä½¿ç”¨åŸå§‹M3U8åœ°å€
                    hls.loadSource(data.m3u8_url);
                    hls.attachMedia(player);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        player.play();
                    });
                } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                    // SafariåŸç”Ÿæ”¯æŒ
                    player.src = data.m3u8_url;
                    player.addEventListener('loadedmetadata', function() {
                        player.play();
                    });
                } else {
                    showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒM3U8è§†é¢‘æ’­æ”¾');
                }
                
                // æ›´æ–°æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.episode-item').forEach((item, i) => {
                    item.classList.toggle('active', i === index);
                });
            })
            .catch(err => {
                showLoading(false);
                showError('åˆ‡æ¢å¤±è´¥: ' + err.message);
            });
        }
        
        function backToSearch() {
            document.getElementById('player').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            const player = document.getElementById('videoPlayer');
            player.pause();
            player.src = '';
            
            // é”€æ¯HLSå®ä¾‹
            if (window.hlsInstance) {
                window.hlsInstance.destroy();
                window.hlsInstance = null;
            }
        }
        

        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(msg) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            
            // æ·»åŠ é”™è¯¯ç±»å‹è¯†åˆ«å’Œæ ·å¼
            if (msg.includes('è¶…æ—¶') || msg.includes('ç½‘ç»œ')) {
                errorDiv.className = 'error network';
            } else if (msg.includes('Token') || msg.includes('éªŒè¯')) {
                errorDiv.className = 'error auth';
            } else {
                errorDiv.className = 'error';
            }
            
            // 3ç§’åè‡ªåŠ¨éšè—é”™è¯¯ä¿¡æ¯
            setTimeout(() => {
                hideError();
            }, 5000);
        }
        
        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'none';
            errorDiv.className = 'error'; // é‡ç½®æ ·å¼
        }
        
        // å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchVideo();
        });
        
        // æ ¼å¼åŒ–è§†é¢‘ç®€ä»‹ä¿¡æ¯
        function formatVideoDescription(description) {
            // è§£æåŸºæœ¬ä¿¡æ¯
            let region = '';
            let year = '';
            let actors = '';
            let director = '';
            let synopsis = '';
            
            // æå–åœ°åŒºä¿¡æ¯ï¼ˆé¿å…é‡å¤ï¼‰
            const regionMatch = description.match(/åœ°åŒº[ï¼š:]\s*([^\s\nå¹´ä»½]+)/);
            if (regionMatch) region = regionMatch[1].trim();
            
            // æå–å¹´ä»½ä¿¡æ¯
            const yearMatch = description.match(/å¹´ä»½[ï¼š:]\s*(\d{4})/);
            if (yearMatch) year = yearMatch[1];
            
            // æå–ä¸»æ¼”ä¿¡æ¯ï¼ˆåªæå–åˆ°ç®€ä»‹å‰çš„å†…å®¹ï¼‰
            const actorsMatch = description.match(/ä¸»æ¼”[ï¼š:]\s*([^\nç®€ä»‹]+)/);
            if (actorsMatch) actors = actorsMatch[1].trim();
            
            // æå–å¯¼æ¼”ä¿¡æ¯
            const directorMatch = description.match(/å¯¼æ¼”[ï¼š:]\s*([^\n]+)/);
            if (directorMatch) director = directorMatch[1].trim();
            
            // æå–ç®€ä»‹ä¿¡æ¯ï¼ˆå»é™¤é‡å¤çš„åœ°åŒºå¹´ä»½ä¿¡æ¯ï¼‰
            const synopsisMatch = description.match(/ç®€ä»‹[ï¼š:]\s*([^]+)/);
            if (synopsisMatch) {
                synopsis = synopsisMatch[1].trim();
                // å»é™¤ç®€ä»‹ä¸­é‡å¤çš„åœ°åŒºå¹´ä»½ä¿¡æ¯
                synopsis = synopsis.replace(/åˆ†ç±»[ï¼š:][^åœ°åŒº]*åœ°åŒº[ï¼š:][^å¹´ä»½]*å¹´ä»½[ï¼š:][^\n]*/, '').trim();
                if (!synopsis) synopsis = 'æš‚æ— è¯¦ç»†å‰§æƒ…ä»‹ç»';
            }
            
            // æ„å»ºæ ¼å¼åŒ–HTML
            let html = '';
            
            // åŸºæœ¬ä¿¡æ¯è¡Œ
            if (region || year) {
                html += `<div class="info-line">`;
                if (region) html += `<span class="info-title">åœ°åŒºï¼š</span><span class="info-content">${region}</span> `;
                if (year) html += `<span class="info-title">å¹´ä»½ï¼š</span><span class="info-content">${year}</span>`;
                html += `</div>`;
            }
            
            // ä¸»æ¼”ä¿¡æ¯ï¼ˆæ¸…ç†å¤šä½™é€—å·å’Œæ¢è¡Œç¬¦ï¼‰
            if (actors) {
                let cleanActors = actors.replace(/,,+/g, ',').replace(/\n/g, ' ').trim();
                if (cleanActors) {
                    html += `<div class="info-line">`;
                    html += `<span class="info-title">ä¸»æ¼”ï¼š</span><span class="info-content">${cleanActors}</span>`;
                    html += `</div>`;
                }
            }
            
            // å¯¼æ¼”ä¿¡æ¯
            if (director) {
                html += `<div class="info-line">`;
                html += `<span class="info-title">å¯¼æ¼”ï¼š</span><span class="info-content">${director}</span>`;
                html += `</div>`;
            }
            
            // ç®€ä»‹ä¿¡æ¯
            if (synopsis) {
                html += `<div class="synopsis">`;
                html += `<span class="info-title">ç®€ä»‹ï¼š</span>`;
                html += `<span class="info-content">${synopsis}</span>`;
                html += `</div>`;
            }
            
            // å¦‚æœæ²¡æœ‰è§£æåˆ°ä»»ä½•ä¿¡æ¯ï¼Œè¿”å›åŸå§‹å†…å®¹
            if (!html) {
                return `<div class="info-content">${description}</div>`;
            }
            
            return html;
        }
    </script>
</body>
</html>